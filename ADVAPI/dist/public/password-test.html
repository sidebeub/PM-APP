<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Password Authentication Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    form {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    input[type="password"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 5px;
    }
    .success {
      background-color: #dff0d8;
      border: 1px solid #d6e9c6;
      color: #3c763d;
    }
    .error {
      background-color: #f2dede;
      border: 1px solid #ebccd1;
      color: #a94442;
    }
    .info-box {
      background-color: #d9edf7;
      border: 1px solid #bce8f1;
      color: #31708f;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .debug-box {
      background-color: #f7f7f9;
      border: 1px solid #e1e1e8;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Password Authentication Test</h1>
  
  <div class="info-box">
    <p><strong>Purpose:</strong> This utility helps diagnose and fix password authentication issues with the Autodesk Viewer App.</p>
    <p><strong>Default Password:</strong> admin123</p>
    <p>If you're having trouble with password authentication, this tool will help identify the issue.</p>
  </div>
  
  <h2>Test Password Authentication</h2>
  
  <form id="auth-test-form">
    <label for="password">Enter Password:</label>
    <input type="password" id="password" name="password" placeholder="Enter password here" required>
    <div>
      <button type="submit">Test Authentication</button>
    </div>
  </form>
  
  <div id="result" style="display: none;"></div>
  
  <div class="debug-box">
    <h3>Authentication Debug Information</h3>
    <pre id="debug-info">No data yet. Run a test first.</pre>
  </div>
  
  <script>
    document.getElementById('auth-test-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const password = document.getElementById('password').value;
      const resultDiv = document.getElementById('result');
      const debugInfo = document.getElementById('debug-info');
      
      resultDiv.innerHTML = 'Testing authentication...';
      resultDiv.style.display = 'block';
      resultDiv.className = 'result';
      
      // Create form data for testing
      const formData = new FormData();
      formData.append('password', password);
      
      // Create debug info
      let debugText = 'Test started at: ' + new Date().toLocaleTimeString() + '\n';
      debugText += 'Password length: ' + password.length + '\n';
      debugText += 'Password characters (masked): ' + '*'.repeat(password.length) + '\n';
      debugText += 'Password hex representation: ' + Array.from(password).map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join(' ') + '\n\n';
      
      try {
        // First test with FormData
        debugText += '=== Testing with FormData (multipart/form-data) ===\n';
        const formDataResponse = await fetch('/api/models/auth-debug', {
          method: 'POST',
          body: formData
        });
        
        const formDataResult = await formDataResponse.json();
        debugText += 'Status: ' + formDataResponse.status + ' ' + formDataResponse.statusText + '\n';
        debugText += 'Response: ' + JSON.stringify(formDataResult, null, 2) + '\n\n';
        
        // Then test with URL encoded form
        debugText += '=== Testing with URLSearchParams (application/x-www-form-urlencoded) ===\n';
        const params = new URLSearchParams();
        params.append('password', password);
        
        const urlEncodedResponse = await fetch('/api/models/auth-debug', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: params
        });
        
        const urlEncodedResult = await urlEncodedResponse.json();
        debugText += 'Status: ' + urlEncodedResponse.status + ' ' + urlEncodedResponse.statusText + '\n';
        debugText += 'Response: ' + JSON.stringify(urlEncodedResult, null, 2) + '\n\n';
        
        // Then test with JSON
        debugText += '=== Testing with JSON (application/json) ===\n';
        const jsonResponse = await fetch('/api/models/auth-debug', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password })
        });
        
        const jsonResult = await jsonResponse.json();
        debugText += 'Status: ' + jsonResponse.status + ' ' + jsonResponse.statusText + '\n';
        debugText += 'Response: ' + JSON.stringify(jsonResult, null, 2) + '\n\n';
        
        // Determine overall result
        const allSuccessful = formDataResponse.ok && urlEncodedResponse.ok && jsonResponse.ok;
        
        if (allSuccessful) {
          resultDiv.innerHTML = '<strong>Success!</strong> Password authentication passed all tests.';
          resultDiv.className = 'result success';
        } else {
          resultDiv.innerHTML = '<strong>Mixed Results</strong> Some authentication methods succeeded while others failed. See details below.';
          resultDiv.className = 'result error';
        }
        
        // Final recommendations
        debugText += '=== Recommendations ===\n';
        if (allSuccessful) {
          debugText += '✅ Your password authentication is working correctly with all methods.\n';
          debugText += '✅ You should now be able to upload and edit models successfully.\n';
        } else {
          if (formDataResponse.ok) {
            debugText += '✅ FormData authentication works - you should be able to upload files.\n';
          } else {
            debugText += '❌ FormData authentication failed - file uploads may not work.\n';
          }
          
          if (urlEncodedResponse.ok) {
            debugText += '✅ URL encoded authentication works - you should be able to edit model metadata.\n';
          } else {
            debugText += '❌ URL encoded authentication failed - editing model metadata may not work.\n';
          }
          
          if (jsonResponse.ok) {
            debugText += '✅ JSON authentication works - API calls should work correctly.\n';
          } else {
            debugText += '❌ JSON authentication failed - some API calls may not work.\n';
          }
          
          debugText += '\nPossible issues:\n';
          debugText += '1. Check for extra spaces in your password\n';
          debugText += '2. Check for uppercase/lowercase issues\n';
          debugText += '3. Check if you need to enclose your password in quotes\n';
          debugText += '4. Try a simpler password (letters and numbers only)\n';
        }
        
      } catch (error) {
        resultDiv.innerHTML = '<strong>Error:</strong> ' + error.message;
        resultDiv.className = 'result error';
        debugText += 'Error: ' + error.message + '\n';
        debugText += 'This may indicate a network or server issue, rather than a password problem.\n';
      }
      
      // Update debug info
      debugInfo.textContent = debugText;
    });
  </script>
  
  <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
    <p><a href="/">&larr; Back to Autodesk Viewer App</a></p>
  </div>
</body>
</html>